name: Nightly Build Check

on:
  schedule:
    # Run at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  # Also run on push to main and PRs for immediate feedback
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start server and verify it responds
        run: |
          npm start &
          SERVER_PID=$!
          sleep 3

          # Check if server is responding
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "Server is running and responding with HTTP 200"
          else
            echo "Server health check failed with HTTP status: $HTTP_STATUS"
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi

          # Check API endpoint
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/amd-issues)

          if [ "$API_STATUS" -eq 200 ]; then
            echo "API endpoint responding with HTTP 200"
          else
            echo "API health check failed with HTTP status: $API_STATUS"
            kill $SERVER_PID 2>/dev/null
            exit 1
          fi

          kill $SERVER_PID 2>/dev/null
          echo "All checks passed!"
