<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLVM Issues Viewer - AMDGPU & SPIR-V</title>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-link: #58a6ff;
            --accent-green: #238636;
            --accent-green-text: white;
            --icon-green: #3fb950;
            --error-bg: #490202;
            --error-border: #f85149;
            --error-text: #f85149;
            --spinner-bg: #30363d;
            --interesting-bg: #1c3a2d;
            --interesting-border: #238636;
            --not-interesting-opacity: 0.4;
            --board-open-bg: #1c2128;
            --board-progress-bg: #1c2128;
            --board-done-bg: #1c2128;
            --drop-zone-bg: rgba(56, 139, 253, 0.1);
            --drop-zone-border: #388bfd;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #f0f0f0;
            --border-color: #d0d7de;
            --text-primary: #1f2328;
            --text-secondary: #656d76;
            --text-link: #0969da;
            --accent-green: #1a7f37;
            --accent-green-text: white;
            --icon-green: #1a7f37;
            --error-bg: #ffebe9;
            --error-border: #ff8182;
            --error-text: #cf222e;
            --spinner-bg: #d0d7de;
            --interesting-bg: #dafbe1;
            --interesting-border: #1a7f37;
            --not-interesting-opacity: 0.45;
            --board-open-bg: #f6f8fa;
            --board-progress-bg: #f6f8fa;
            --board-done-bg: #f6f8fa;
            --drop-zone-bg: rgba(9, 105, 218, 0.1);
            --drop-zone-border: #0969da;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            text-align: center;
            color: var(--text-link);
            font-size: 2em;
        }

        .theme-toggle {
            position: absolute;
            right: 0;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .theme-toggle svg {
            width: 16px;
            height: 16px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--border-color);
        }

        .tab-btn.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--accent-green-text);
        }

        .tab-btn.board-btn {
            background: #8957e5;
            border-color: #8957e5;
            color: white;
        }

        .tab-btn.board-btn:hover {
            background: #7048c5;
            border-color: #7048c5;
        }

        .tab-btn.board-btn.active {
            background: #6e40c9;
            border-color: #6e40c9;
        }

        .tab-content {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--spinner-bg);
            border-top: 3px solid var(--text-link);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .count {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .count strong {
            color: var(--text-link);
        }

        .issue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .issue-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            transition: all 0.3s;
        }

        .issue-card:hover {
            border-color: var(--text-link);
        }

        /* Interesting state */
        .issue-card.interesting {
            background: var(--interesting-bg);
            border-color: var(--interesting-border);
            border-width: 2px;
        }

        /* Not interesting state */
        .issue-card.not-interesting {
            opacity: var(--not-interesting-opacity);
        }

        .issue-card.not-interesting:hover {
            opacity: 0.7;
        }

        .issue-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
        }

        .issue-icon {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            margin-top: 4px;
        }

        .issue-icon.open,
        .issue-icon.pr {
            color: var(--icon-green);
        }

        .issue-title {
            flex: 1;
        }

        .issue-title a {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            line-height: 1.4;
        }

        .issue-title a:hover {
            color: var(--text-link);
        }

        .issue-number {
            color: var(--text-secondary);
            font-weight: normal;
        }

        /* Flag buttons container */
        .flag-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex-shrink: 0;
            margin-left: 10px;
            max-width: 220px;
        }

        .flag-btn {
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .flag-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .flag-btn.active-interesting {
            background: #238636;
            border-color: #238636;
            color: white;
        }

        .flag-btn.active-not-interesting {
            background: #6e7681;
            border-color: #6e7681;
            color: white;
        }

        .flag-btn svg {
            width: 12px;
            height: 12px;
        }

        .add-to-board-btn {
            width: 100%;
            padding: 4px 10px;
            border: 1px solid #8957e5;
            background: transparent;
            color: #8957e5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .add-to-board-btn:hover {
            background: #8957e5;
            color: white;
        }

        .add-to-board-btn.on-board {
            background: #6e40c9;
            border-color: #6e40c9;
            color: white;
            cursor: default;
        }

        .add-to-board-btn svg {
            width: 12px;
            height: 12px;
        }

        .issue-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .labels {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .label {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .error {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            color: var(--error-text);
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }

        .refresh-btn {
            display: block;
            margin: 0 auto 20px;
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--border-color);
        }

        .info {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            transition: background-color 0.3s;
        }

        .info strong {
            color: var(--text-primary);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--border-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination .page-info strong {
            color: var(--text-link);
        }

        /* ==================== Board Styles ==================== */
        .board-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .board-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .board-header h2 {
            color: var(--text-link);
            font-size: 1.5em;
        }

        .board-actions {
            display: flex;
            gap: 10px;
        }

        .board-actions button {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .board-actions button:hover {
            background: var(--border-color);
        }

        .board-actions button.danger {
            color: var(--error-text);
            border-color: var(--error-border);
        }

        .board-actions button.danger:hover {
            background: var(--error-bg);
        }

        .board-actions button svg {
            width: 16px;
            height: 16px;
        }

        .board-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            min-height: 400px;
        }

        .board-column {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .board-column-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .board-column-header .column-count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .board-column.open .board-column-header {
            color: #58a6ff;
        }

        .board-column.in-progress .board-column-header {
            color: #d29922;
        }

        .board-column.done .board-column-header {
            color: #3fb950;
        }

        .board-column-content {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 200px;
        }

        .board-column-content.drag-over {
            background: var(--drop-zone-bg);
        }

        .board-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s;
        }

        .board-card:active {
            cursor: grabbing;
        }

        .board-card.dragging {
            opacity: 0.5;
        }

        .board-card:hover {
            border-color: var(--text-link);
        }

        .board-card-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .board-card-title a {
            color: var(--text-primary);
            text-decoration: none;
        }

        .board-card-title a:hover {
            color: var(--text-link);
        }

        .board-card-meta {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .board-card-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .board-card-remove:hover {
            color: var(--error-text);
            background: var(--error-bg);
        }

        .board-card-remove svg {
            width: 14px;
            height: 14px;
        }

        .board-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .board-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        @media (max-width: 900px) {
            .board-columns {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .theme-toggle {
                position: static;
            }
            .flag-buttons {
                flex-direction: column;
                gap: 4px;
            }
            .flag-btn {
                font-size: 10px;
                padding: 3px 6px;
            }
            .board-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LLVM Issues & PRs Viewer</h1>
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
            <svg id="theme-icon-dark" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.061 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z"></path>
            </svg>
            <svg id="theme-icon-light" viewBox="0 0 16 16" fill="currentColor" style="display: none;">
                <path fill-rule="evenodd" d="M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z"></path>
            </svg>
            <span id="theme-label">Light</span>
        </button>
    </div>

    <div class="tabs" id="tabs-container">
        <!-- Tabs will be generated dynamically -->
    </div>

    <div id="tab-contents">
        <!-- Tab contents will be generated dynamically -->
    </div>

    <!-- Board View -->
    <div id="board-view" class="tab-content">
        <div class="board-container">
            <div class="board-header">
                <h2>Project Board</h2>
                <div class="board-actions">
                    <button onclick="switchToViewer()">
                        <svg viewBox="0 0 16 16" fill="currentColor">
                            <path fill-rule="evenodd" d="M7.78 12.53a.75.75 0 01-1.06 0L2.47 8.28a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 1.06L4.81 7h7.44a.75.75 0 010 1.5H4.81l2.97 2.97a.75.75 0 010 1.06z"></path>
                        </svg>
                        Back to Viewer
                    </button>
                    <button class="danger" onclick="clearBoard()">
                        <svg viewBox="0 0 16 16" fill="currentColor">
                            <path fill-rule="evenodd" d="M6.5 1.75a.25.25 0 01.25-.25h2.5a.25.25 0 01.25.25V3h-3V1.75zm4.5 0V3h2.25a.75.75 0 010 1.5H2.75a.75.75 0 010-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75zM4.496 6.675a.75.75 0 10-1.492.15l.66 6.6A1.75 1.75 0 005.405 15h5.19c.9 0 1.652-.681 1.741-1.576l.66-6.6a.75.75 0 00-1.492-.149l-.66 6.6a.25.25 0 01-.249.225h-5.19a.25.25 0 01-.249-.225l-.66-6.6z"></path>
                        </svg>
                        Clear Board
                    </button>
                </div>
            </div>
            <div class="board-columns" id="board-columns">
                <div class="board-column open" data-column="open">
                    <div class="board-column-header">
                        <span>Open</span>
                        <span class="column-count" id="open-count">0</span>
                    </div>
                    <div class="board-column-content" id="board-open"></div>
                </div>
                <div class="board-column in-progress" data-column="inProgress">
                    <div class="board-column-header">
                        <span>In Progress</span>
                        <span class="column-count" id="inProgress-count">0</span>
                    </div>
                    <div class="board-column-content" id="board-inProgress"></div>
                </div>
                <div class="board-column done" data-column="done">
                    <div class="board-column-header">
                        <span>Done</span>
                        <span class="column-count" id="done-count">0</span>
                    </div>
                    <div class="board-column-content" id="board-done"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Configuration ====================
        let appConfig = { tabs: [] };
        let currentView = 'viewer'; // 'viewer' or 'board'

        // ==================== Local Storage for Flags ====================
        const STORAGE_KEY = 'llvm-issues-flags';
        const BOARD_STORAGE_KEY = 'llvm-issues-board';

        function getFlags() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error reading flags from localStorage:', e);
                return {};
            }
        }

        function saveFlags(flags) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(flags));
            } catch (e) {
                console.error('Error saving flags to localStorage:', e);
            }
        }

        // Use item URL as unique key (issue numbers can collide across repos)
        function getItemKey(item) {
            return item.html_url;
        }

        function getItemFlag(itemKey) {
            const flags = getFlags();
            return flags[itemKey] || null;
        }

        function setItemFlag(itemKey, flag) {
            const flags = getFlags();
            if (flag === null) {
                delete flags[itemKey];
            } else {
                flags[itemKey] = flag;
            }
            saveFlags(flags);
            updateCardVisual(itemKey, flag);
        }

        function toggleFlag(itemKey, flagType) {
            const currentFlag = getItemFlag(itemKey);
            if (currentFlag === flagType) {
                setItemFlag(itemKey, null);
            } else {
                setItemFlag(itemKey, flagType);
            }
        }

        function updateCardVisual(itemKey, flag) {
            const card = document.querySelector(`[data-item-key="${CSS.escape(itemKey)}"]`);
            if (!card) return;

            card.classList.remove('interesting', 'not-interesting');
            if (flag === 'interesting') {
                card.classList.add('interesting');
            } else if (flag === 'not-interesting') {
                card.classList.add('not-interesting');
            }

            const interestingBtn = card.querySelector('.flag-btn-interesting');
            const notInterestingBtn = card.querySelector('.flag-btn-not-interesting');

            if (interestingBtn) {
                interestingBtn.classList.toggle('active-interesting', flag === 'interesting');
            }
            if (notInterestingBtn) {
                notInterestingBtn.classList.toggle('active-not-interesting', flag === 'not-interesting');
            }
        }

        // ==================== Board Storage ====================
        function getBoard() {
            try {
                const stored = localStorage.getItem(BOARD_STORAGE_KEY);
                return stored ? JSON.parse(stored) : { open: [], inProgress: [], done: [] };
            } catch (e) {
                console.error('Error reading board from localStorage:', e);
                return { open: [], inProgress: [], done: [] };
            }
        }

        function saveBoard(board) {
            try {
                localStorage.setItem(BOARD_STORAGE_KEY, JSON.stringify(board));
            } catch (e) {
                console.error('Error saving board to localStorage:', e);
            }
        }

        function isOnBoard(itemUrl) {
            const board = getBoard();
            const allItems = [...board.open, ...board.inProgress, ...board.done];
            return allItems.some(i => i.html_url === itemUrl);
        }

        function addToBoard(item) {
            const board = getBoard();
            // Check if item already exists in any column
            if (isOnBoard(item.html_url)) {
                return false; // Already on board
            }
            board.open.push(item);
            saveBoard(board);
            renderBoard();
            // Update the button state in viewer
            updateAddToBoardButton(item.html_url, true);
            return true;
        }

        function addToBoardFromViewer(button) {
            const encoded = button.getAttribute('data-item');
            if (encoded) {
                try {
                    const itemJson = decodeURIComponent(atob(encoded));
                    const item = JSON.parse(itemJson);
                    addToBoard(item);
                } catch (e) {
                    console.error('Error parsing item data:', e);
                }
            }
        }

        function updateAddToBoardButton(itemUrl, onBoard) {
            const btn = document.querySelector(`[data-board-url="${CSS.escape(itemUrl)}"]`);
            if (btn) {
                if (onBoard) {
                    btn.classList.add('on-board');
                    btn.innerHTML = `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg><span>On Board</span>`;
                } else {
                    btn.classList.remove('on-board');
                    btn.innerHTML = `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M7.75 2a.75.75 0 01.75.75V7h4.25a.75.75 0 010 1.5H8.5v4.25a.75.75 0 01-1.5 0V8.5H2.75a.75.75 0 010-1.5H7V2.75A.75.75 0 017.75 2z"></path></svg><span>Add to Board</span>`;
                }
            }
        }

        function removeFromBoard(itemUrl) {
            const board = getBoard();
            board.open = board.open.filter(i => i.html_url !== itemUrl);
            board.inProgress = board.inProgress.filter(i => i.html_url !== itemUrl);
            board.done = board.done.filter(i => i.html_url !== itemUrl);
            saveBoard(board);
            renderBoard();
            // Update the button state in viewer if visible
            updateAddToBoardButton(itemUrl, false);
        }

        function moveOnBoard(itemUrl, targetColumn) {
            const board = getBoard();
            let item = null;

            // Find and remove from current column
            for (const col of ['open', 'inProgress', 'done']) {
                const idx = board[col].findIndex(i => i.html_url === itemUrl);
                if (idx !== -1) {
                    item = board[col].splice(idx, 1)[0];
                    break;
                }
            }

            if (item) {
                board[targetColumn].push(item);
                saveBoard(board);
                renderBoard();
            }
        }

        function clearBoard() {
            if (confirm('Are you sure you want to clear the entire board? This cannot be undone.')) {
                saveBoard({ open: [], inProgress: [], done: [] });
                renderBoard();
            }
        }

        // ==================== Theme handling ====================
        function getPreferredTheme() {
            const stored = localStorage.getItem('theme');
            if (stored) return stored;
            return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeButton(theme);
        }

        function updateThemeButton(theme) {
            const darkIcon = document.getElementById('theme-icon-dark');
            const lightIcon = document.getElementById('theme-icon-light');
            const label = document.getElementById('theme-label');

            if (theme === 'dark') {
                darkIcon.style.display = 'block';
                lightIcon.style.display = 'none';
                label.textContent = 'Light';
            } else {
                darkIcon.style.display = 'none';
                lightIcon.style.display = 'block';
                label.textContent = 'Dark';
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
        }

        // Initialize theme
        setTheme(getPreferredTheme());

        // ==================== SVG icons ====================
        const issueIcon = `<svg class="issue-icon open" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 9.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
            <path fill-rule="evenodd" d="M8 0a8 8 0 100 16A8 8 0 008 0zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"></path>
        </svg>`;

        const prIcon = `<svg class="issue-icon pr" viewBox="0 0 16 16" fill="currentColor">
            <path fill-rule="evenodd" d="M7.177 3.073L9.573.677A.25.25 0 0110 .854v4.792a.25.25 0 01-.427.177L7.177 3.427a.25.25 0 010-.354zM3.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122v5.256a2.251 2.251 0 11-1.5 0V5.372A2.25 2.25 0 011.5 3.25zM11 2.5h-1V4h1a1 1 0 011 1v5.628a2.251 2.251 0 101.5 0V5A2.5 2.5 0 0011 2.5zm1 10.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0zM3.75 12a.75.75 0 100 1.5.75.75 0 000-1.5z"></path>
        </svg>`;

        const starIcon = `<svg viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 .25a.75.75 0 01.673.418l1.882 3.815 4.21.612a.75.75 0 01.416 1.279l-3.046 2.97.719 4.192a.75.75 0 01-1.088.791L8 12.347l-3.766 1.98a.75.75 0 01-1.088-.79l.72-4.194L.818 6.374a.75.75 0 01.416-1.28l4.21-.611L7.327.668A.75.75 0 018 .25z"></path>
        </svg>`;

        const xIcon = `<svg viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.75.75 0 111.06 1.06L9.06 8l3.22 3.22a.75.75 0 11-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 01-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 010-1.06z"></path>
        </svg>`;

        // ==================== Utility functions ====================
        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(0, 2), 16);
            const g = parseInt(hexcolor.substr(2, 2), 16);
            const b = parseInt(hexcolor.substr(4, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== View Switching ====================
        function switchToBoard() {
            currentView = 'board';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="board"]').classList.add('active');
            document.getElementById('board-view').classList.add('active');
            renderBoard();
        }

        function switchToViewer() {
            currentView = 'viewer';
            const firstTab = appConfig.tabs[0];
            if (firstTab) {
                switchTab(firstTab.id);
            }
        }

        // ==================== Dynamic UI Generation ====================
        function generateTabs(config) {
            const tabsContainer = document.getElementById('tabs-container');
            const tabContents = document.getElementById('tab-contents');

            tabsContainer.innerHTML = '';
            tabContents.innerHTML = '';

            config.tabs.forEach((tab, index) => {
                const tabBtn = document.createElement('button');
                tabBtn.className = 'tab-btn' + (index === 0 ? ' active' : '');
                tabBtn.setAttribute('data-tab', tab.id);
                tabBtn.textContent = tab.label;
                tabBtn.addEventListener('click', () => {
                    currentView = 'viewer';
                    switchTab(tab.id);
                    document.getElementById('board-view').classList.remove('active');
                });
                tabsContainer.appendChild(tabBtn);

                const tabContent = document.createElement('div');
                tabContent.id = tab.id;
                tabContent.className = 'tab-content' + (index === 0 ? ' active' : '');

                const isPR = tab.type === 'prs';

                tabContent.innerHTML = `
                    <div class="info">
                        <strong>${escapeHtml(tab.label)}:</strong> ${escapeHtml(tab.description)}
                    </div>
                    <button class="refresh-btn" onclick="loadTabData('${tab.id}', 1)">Refresh</button>
                    <div id="${tab.id}-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading ${escapeHtml(tab.label.toLowerCase())}...
                        </div>
                    </div>
                `;

                tabContents.appendChild(tabContent);
            });

            // Add Board button at the end
            const boardBtn = document.createElement('button');
            boardBtn.className = 'tab-btn board-btn';
            boardBtn.setAttribute('data-tab', 'board');
            boardBtn.textContent = 'Board';
            boardBtn.addEventListener('click', switchToBoard);
            tabsContainer.appendChild(boardBtn);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);

            if (tabBtn) tabBtn.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
        }

        // ==================== Board Rendering ====================
        function renderBoard() {
            const board = getBoard();

            ['open', 'inProgress', 'done'].forEach(column => {
                const container = document.getElementById(`board-${column}`);
                const countEl = document.getElementById(`${column}-count`);
                const items = board[column];

                countEl.textContent = items.length;

                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="board-empty">
                            <svg viewBox="0 0 16 16" fill="currentColor">
                                <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0114.25 16H1.75A1.75 1.75 0 010 14.25V1.75zM1.75 1.5a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V1.75a.25.25 0 00-.25-.25H1.75z"></path>
                            </svg>
                            <div>No items</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = items.map(item => {
                        const isPR = item.html_url.includes('/pull/');
                        const icon = isPR ? 'PR' : 'Issue';
                        const number = item.number || item.html_url.split('/').pop();

                        return `
                            <div class="board-card" draggable="true" data-url="${escapeHtml(item.html_url)}">
                                <div class="board-card-title">
                                    <a href="${item.html_url}" target="_blank" rel="noopener noreferrer">
                                        ${escapeHtml(item.title)}
                                    </a>
                                </div>
                                <div class="board-card-meta">
                                    <span>${icon} #${number}</span>
                                    <button class="board-card-remove" onclick="removeFromBoard('${escapeHtml(item.html_url)}')" title="Remove from board">
                                        ${xIcon}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Add drag events to board cards
                container.querySelectorAll('.board-card').forEach(card => {
                    card.addEventListener('dragstart', handleBoardCardDragStart);
                    card.addEventListener('dragend', handleBoardCardDragEnd);
                });
            });

            // Setup column drop zones
            document.querySelectorAll('.board-column-content').forEach(col => {
                col.addEventListener('dragover', handleColumnDragOver);
                col.addEventListener('dragleave', handleColumnDragLeave);
                col.addEventListener('drop', handleColumnDrop);
            });
        }

        // ==================== Drag and Drop for Board Cards ====================
        function handleBoardCardDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.url);
        }

        function handleBoardCardDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleColumnDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleColumnDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleColumnDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            const url = e.dataTransfer.getData('text/plain');
            const targetColumn = e.currentTarget.parentElement.dataset.column;

            if (url) {
                moveOnBoard(url, targetColumn);
            }
        }

        // ==================== Rendering ====================
        function renderItems(data, containerId, isPR, tabId) {
            const container = document.getElementById(containerId);
            const items = data.items;
            const totalCount = data.total_count;
            const currentPage = data.page;
            const totalPages = data.total_pages;

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="loading">No items found.</div>';
                return;
            }

            // Sort items: interesting first, then normal, then not-interesting
            const sortedItems = [...items].sort((a, b) => {
                const flagA = getItemFlag(a.html_url);
                const flagB = getItemFlag(b.html_url);

                const getPriority = (flag) => {
                    if (flag === 'interesting') return 2;
                    if (flag === 'not-interesting') return 0;
                    return 1;
                };

                return getPriority(flagB) - getPriority(flagA);
            });

            const icon = isPR ? prIcon : issueIcon;
            const itemType = isPR ? 'pull requests' : 'issues';
            const startItem = (currentPage - 1) * 100 + 1;
            const endItem = Math.min(currentPage * 100, totalCount);

            let html = `<div class="count">Showing <strong>${startItem}-${endItem}</strong> of <strong>${totalCount}</strong> ${itemType}</div>`;
            html += '<div class="issue-list">';

            sortedItems.forEach(item => {
                const itemKey = item.html_url;
                const labels = item.labels.map(label =>
                    `<span class="label" style="background-color: #${label.color}; color: ${getContrastColor(label.color)}">${escapeHtml(label.name)}</span>`
                ).join('');

                const date = new Date(item.updated_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const currentFlag = getItemFlag(itemKey);
                const cardClass = currentFlag === 'interesting' ? 'interesting' :
                                  currentFlag === 'not-interesting' ? 'not-interesting' : '';
                const interestingActive = currentFlag === 'interesting' ? 'active-interesting' : '';
                const notInterestingActive = currentFlag === 'not-interesting' ? 'active-not-interesting' : '';

                // Store item data as JSON for adding to board
                const itemData = {
                    html_url: item.html_url,
                    title: item.title,
                    number: item.number,
                    user: item.user ? { login: item.user.login } : null,
                    labels: item.labels
                };
                // Encode for safe HTML attribute storage
                const itemDataAttr = btoa(encodeURIComponent(JSON.stringify(itemData)));

                const onBoard = isOnBoard(itemKey);
                const boardBtnClass = onBoard ? 'on-board' : '';
                const boardBtnContent = onBoard
                    ? `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path></svg><span>On Board</span>`
                    : `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M7.75 2a.75.75 0 01.75.75V7h4.25a.75.75 0 010 1.5H8.5v4.25a.75.75 0 01-1.5 0V8.5H2.75a.75.75 0 010-1.5H7V2.75A.75.75 0 017.75 2z"></path></svg><span>Add to Board</span>`;

                html += `
                    <div class="issue-card ${cardClass}" data-item-key="${escapeHtml(itemKey)}">
                        <div class="issue-header">
                            ${icon}
                            <div class="issue-title">
                                <a href="${item.html_url}" target="_blank" rel="noopener noreferrer">
                                    ${escapeHtml(item.title)}
                                    <span class="issue-number">#${item.number}</span>
                                </a>
                            </div>
                            <div class="flag-buttons">
                                <button class="flag-btn flag-btn-interesting ${interestingActive}"
                                        onclick="toggleFlag('${escapeHtml(itemKey)}', 'interesting')"
                                        title="Mark as interesting">
                                    ${starIcon}
                                    <span>Interesting</span>
                                </button>
                                <button class="flag-btn flag-btn-not-interesting ${notInterestingActive}"
                                        onclick="toggleFlag('${escapeHtml(itemKey)}', 'not-interesting')"
                                        title="Mark as not interesting">
                                    ${xIcon}
                                    <span>Not Interesting</span>
                                </button>
                                <button class="add-to-board-btn ${boardBtnClass}"
                                        data-board-url="${escapeHtml(itemKey)}"
                                        data-item="${itemDataAttr}"
                                        onclick="addToBoardFromViewer(this)"
                                        title="${onBoard ? 'Already on board' : 'Add to board'}">
                                    ${boardBtnContent}
                                </button>
                            </div>
                        </div>
                        <div class="issue-meta">
                            <span>Updated: ${date}</span>
                            ${item.user ? `<span>by ${escapeHtml(item.user.login)}</span>` : ''}
                            ${labels ? `<div class="labels">${labels}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            if (totalPages > 1) {
                html += `
                    <div class="pagination">
                        <button onclick="loadTabData('${tabId}', 1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
                        <button onclick="loadTabData('${tabId}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                        <span class="page-info">Page <strong>${currentPage}</strong> of <strong>${totalPages}</strong></span>
                        <button onclick="loadTabData('${tabId}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                        <button onclick="loadTabData('${tabId}', ${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${escapeHtml(message)}
                    <br><br>
                    Note: GitHub API has rate limits. Try again in a few minutes.
                </div>
            `;
        }

        // ==================== Data loading functions ====================
        async function loadTabData(tabId, page = 1) {
            const tab = appConfig.tabs.find(t => t.id === tabId);
            if (!tab) {
                console.error(`Tab ${tabId} not found in config`);
                return;
            }

            const containerId = `${tabId}-content`;
            const container = document.getElementById(containerId);
            const isPR = tab.type === 'prs';

            container.innerHTML = `<div class="loading"><div class="spinner"></div>Loading ${tab.label.toLowerCase()}...</div>`;

            try {
                const response = await fetch(`/api/tab/${tabId}?page=${page}`);
                const data = await response.json();

                if (data.error) {
                    showError(containerId, data.error);
                    return;
                }

                renderItems(data, containerId, isPR, tabId);
            } catch (error) {
                showError(containerId, error.message);
            }
        }

        // ==================== Initialization ====================
        async function initApp() {
            try {
                const response = await fetch('/api/config');
                appConfig = await response.json();

                generateTabs(appConfig);

                appConfig.tabs.forEach(tab => {
                    loadTabData(tab.id);
                });

                renderBoard();
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('tab-contents').innerHTML = `
                    <div class="error">
                        <strong>Error loading configuration:</strong> ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
